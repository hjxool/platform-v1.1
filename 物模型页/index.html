<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>物模型</title>
  <link rel="stylesheet" href="../module/element-ui.css">
  <link rel="stylesheet" href="../module/common_style.css">
  <link rel="stylesheet" href="./index.css">
</head>

<body>
  <div id="index" v-cloak>
    <!-- 按钮选项栏 -->
    <div class="nav_layout">
      <el-button type="primary" round @click="add_protocol">添加自定义功能</el-button>
      <div class="history_layout">
        <span style="margin-right: 20px;">历史版本</span>
        <el-select style="width:200px;" v-model="history_selected" placeholder="请选择版本"
          @change="model_select(history_selected)">
          <el-option v-for="ver,index in history_list" :key="index" :label="ver.profile.version" :value="index">
          </el-option>
        </el-select>
      </div>
      <el-button @click="new_ver_model">新增版本</el-button>
    </div>
    <!-- 表格栏 -->
    <div style="padding:0 10px;overflow: auto;">
      <el-table :data="protocol_list" border>
        <el-table-column prop="type" label="功能类型" width="150"></el-table-column>
        <el-table-column prop="name" label="功能名称"></el-table-column>
        <el-table-column prop="identifier" label="标识符"></el-table-column>
        <el-table-column prop="dataType_text" label="数据定义"></el-table-column>
        <el-table-column label="操作" width="100" fixed="right">
          <template slot-scope="scope">
            <el-button v-if="history_list[history_selected].profile.published==='0'" @click="edit_protocol(scope.row)"
              type="text" size="small">编辑</el-button>
            <el-button v-if="history_list[history_selected].profile.published==='0'" @click="delete_protocol(scope.row)"
              type="text" size="small">删除</el-button>
            <el-button v-if="history_list[history_selected].profile.published==='1'" @click="check_protocol(scope.row)"
              type="text" size="small">查看</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>

    <!-- 透明包裹层 设定固定大小 滚动显示 页面居中 -->
    <div class="custom_center" v-for="card,index in form_list">
      <!-- 遮罩 -->
      <div class="shadow"></div>
      <div class="card_layout">
        <!-- 编辑及新建卡片 -->
        <el-card style="z-index: 990;overflow: auto;max-height: 100%;" shadow="hover">
          <el-form label-position="top" :rules="static_params.form_rules" :model="card" ref="card_verify">

            <!-- 选择属性、事件、服务 -->
            <el-form-item label="物模型设置" v-if="static_params.add_edit=='add'&&index==0">
              <el-radio-group v-model="card.type" size="small" @change="clean_form(card)">
                <el-radio-button label="属性">属性</el-radio-button>
                <el-radio-button label="事件">事件</el-radio-button>
                <el-radio-button label="服务">服务</el-radio-button>
              </el-radio-group>
            </el-form-item>
            <!-- 属性设置 -->
            <template v-if="card.type=='属性'">
              <el-form-item label="属性名称" prop="name">
                <el-input v-model="card.name" placeholder="请输入属性名称" :disabled="static_params.add_edit=='check'">
                </el-input>
              </el-form-item>
              <el-form-item label="属性标识" prop="identifier">
                <el-input v-model="card.identifier" placeholder="请输入您的标识符" :disabled="static_params.add_edit=='check'">
                </el-input>
              </el-form-item>
              <el-form-item label="数据类型" prop="dataType">
                <el-select v-model="card.dataType" placeholder="请选择数据类型" @change="format_type_data(card)"
                  :disabled="static_params.add_edit=='check'">
                  <el-option v-for="item in static_params.type_options" :key="item.value" :label="item.name"
                    :value="item.value"></el-option>
                </el-select>
              </el-form-item>
              <template v-if="card.dataType=='int'||card.dataType=='float'||card.dataType=='double'">
                <el-form-item label="取值范围">
                  <div style="display: flex;">
                    <el-input v-model="card.min" placeholder="最小值" :disabled="static_params.add_edit=='check'">
                    </el-input>
                    ~
                    <el-input v-model="card.max" placeholder="最大值" :disabled="static_params.add_edit=='check'">
                    </el-input>
                  </div>
                </el-form-item>
                <el-form-item label="步长">
                  <el-input v-model="card.step" placeholder="请输入步长" :disabled="static_params.add_edit=='check'">
                  </el-input>
                </el-form-item>
                <el-form-item label="单位">
                  <el-select v-model="card.unit" placeholder="请选择单位" :disabled="static_params.add_edit=='check'">
                    <el-option v-for="item in static_params.unit_options" :key="item.value" :label="item.value"
                      :value="item.value"></el-option>
                  </el-select>
                </el-form-item>
              </template>
              <template v-if="card.dataType=='text'">
                <el-form-item label="数据长度" prop="textLength">
                  <el-input v-model="card.textLength" @blur="form_verify(card.textLength,'textLength')" ref="textLength"
                    placeholder="请输入数据长度" :disabled="static_params.add_edit=='check'">
                  </el-input>
                  <span class="verify_text" v-show="rules.textLength.show">{{rules.textLength.message}}</span>
                </el-form-item>
              </template>
              <template v-if="card.dataType=='struct'">
                <el-form-item label="JSON对象" prop="struct_array">
                  <div class="struct_array_layout" v-for="item,struct_index in card.struct_array">
                    <span style="font-size: 12px;color: #555;">参数名称： {{item.name}}</span>
                    <div>
                      <span class="struct_array_button" v-if="history_list[history_selected].profile.published==='0'"
                        @click="edit_child_json(item)">编辑</span>
                      <span style="color: rgb(0, 112, 204);cursor: pointer;"
                        v-if="history_list[history_selected].profile.published==='0'"
                        @click="del_child_json(card,struct_index)">删除</span>
                      <span style="color: rgb(0, 112, 204);cursor: pointer;"
                        v-if="history_list[history_selected].profile.published==='1'"
                        @click="check_child_json(item)">查看</span>
                    </div>
                  </div>
                  <div class="verify_text" v-if="card.struct_array.length==0">不能为空</div>
                  <span style="color: rgb(0, 112, 204);cursor: pointer;font-size: 12px;" @click="add_child_property">+
                    新增参数</span>
                </el-form-item>
              </template>
              <template v-if="card.dataType=='array'">
                <el-form-item label="元素类型" prop="itemType">
                  <el-radio-group v-model="card.itemType" :disabled="static_params.add_edit=='check'">
                    <el-radio v-for="item in static_params.array_type_options" :label="item.value">{{item.name}}
                    </el-radio>
                  </el-radio-group>
                </el-form-item>
                <el-form-item label="元素个数" prop="size">
                  <el-input v-model="card.size" @blur="form_verify(card.size,'size')" ref="size" placeholder="请输入元素个数"
                    :disabled="static_params.add_edit=='check'">
                  </el-input>
                  <span class="verify_text" v-show="rules.size.show">{{rules.size.message}}</span>
                </el-form-item>
                <template v-if="card.itemType=='struct'">
                  <el-form-item label="JSON对象" prop="struct_array">
                    <div class="struct_array_layout" v-for="item,struct_index in card.struct_array">
                      <span style="font-size: 12px;color: #555;">参数名称： {{item.name}}</span>
                      <div>
                        <span class="struct_array_button" v-if="history_list[history_selected].profile.published==='0'"
                          @click="edit_child_json(item)">编辑</span>
                        <span style="color: rgb(0, 112, 204);cursor: pointer;"
                          v-if="history_list[history_selected].profile.published==='0'"
                          @click="del_child_json(card,struct_index)">删除</span>
                        <span style="color: rgb(0, 112, 204);cursor: pointer;"
                          v-if="history_list[history_selected].profile.published==='1'"
                          @click="check_child_json(item)">查看</span>
                      </div>
                    </div>
                    <div class="verify_text" v-if="card.struct_array.length==0">不能为空</div>
                    <span style="color: rgb(0, 112, 204);cursor: pointer;font-size: 12px;" @click="add_child_property">+
                      新增参数</span>
                  </el-form-item>
                </template>
              </template>
            </template>
            <!-- 事件设置 -->
            <template v-if="card.type=='事件'">
              <el-form-item label="事件名称" prop="name">
                <el-input v-model="card.name" :disabled="static_params.add_edit=='check'"></el-input>
              </el-form-item>
              <el-form-item label="事件标识" prop="identifier">
                <el-input v-model="card.identifier" :disabled="static_params.add_edit=='check'"></el-input>
              </el-form-item>
              <el-form-item label="事件类型" prop="dataType">
                <el-radio-group v-model="card.dataType" :disabled="static_params.add_edit=='check'">
                  <el-radio v-for="item in static_params.event_type_options" :label="item.value">{{item.name}}
                  </el-radio>
                </el-radio-group>
              </el-form-item>
              <el-form-item label="输出参数">
                <el-select v-model="card.outputData" :disabled="static_params.add_edit=='check'" value-key="propertyId"
                  placeholder="请选择属性" multiple clearable>
                  <el-option v-for="item in history_list[history_selected].properties" :label="item.name" :value="item">
                  </el-option>
                </el-select>
              </el-form-item>
            </template>
            <!-- 服务设置 -->
            <template v-if="card.type=='服务'">
              <el-form-item label="服务名称" prop="name">
                <el-input v-model="card.name" :disabled="static_params.add_edit=='check'"></el-input>
              </el-form-item>
              <el-form-item label="服务标识" prop="identifier">
                <el-input v-model="card.identifier" :disabled="static_params.add_edit=='check'"></el-input>
              </el-form-item>
              <el-form-item label="调用方式" prop="dataType">
                <el-radio-group v-model="card.dataType" :disabled="static_params.add_edit=='check'">
                  <el-radio v-for="item in static_params.server_type_options" :label="item.value">{{item.name}}
                  </el-radio>
                </el-radio-group>
              </el-form-item>
              <el-form-item label="输入参数">
                <el-select v-model="card.inputData" :disabled="static_params.add_edit=='check'" value-key="propertyId"
                  placeholder="请选择输入属性" multiple clearable>
                  <el-option v-for="item in history_list[history_selected].properties" :label="item.name" :value="item">
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item label="输出参数">
                <el-select v-model="card.outputData" :disabled="static_params.add_edit=='check'" value-key="propertyId"
                  placeholder="请选择输出属性" multiple clearable>
                  <el-option v-for="item in history_list[history_selected].properties" :label="item.name" :value="item">
                  </el-option>
                </el-select>
              </el-form-item>
            </template>

            <!-- 按钮 -->
            <el-form-item class="button_layout">
              <el-button type="primary" @click="submit_form(card,index)" :disabled="static_params.add_edit=='check'">保存
              </el-button>
              <el-button @click="del_form">取消</el-button>
            </el-form-item>
          </el-form>
        </el-card>
      </div>
    </div>

    <!-- 临时 发布物模型按钮 用绝对定位先弄个死的 -->
    <template v-if="!static_params.first_load">
      <el-card class="footer" v-if="history_list[history_selected].profile.published==='0'">
        <el-button type="primary" size="small" @click="publish_model">发布上线</el-button>
      </el-card>
    </template>
  </div>

  <script src="../module/vue.js"></script>
  <script src="../module/element-ui.js"></script>
  <script src="../module/axios.min.js"></script>
  <script src="../module/common_function.js"></script>
  <script src="./index.js"></script>
</body>

</html>